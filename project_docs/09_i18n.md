# Internationalization (i18n)

> Multi-language support system based on Qt i18n framework

**Status:** ‚è≥ Planned (Phase 2+)
**Last Updated:** 2025-11-19

**Migration Note:** Migrated from wxWidgets wxLocale + GNU gettext to Qt i18n (tr() + Qt Linguist + .ts/.qm files) on 2025-11-19. Previous bwx_sdk implementation archived in wxwidgets-archive branch.

---

## Overview

Kalahari uses the **Qt i18n framework** for multi-language support, providing a modern, integrated translation workflow.

**Key Features:**
- Qt tr() macro for translatable strings
- Qt Linguist visual translation tool
- .ts (Translation Source) XML format for human editing
- .qm (Qt Message) compiled binary format for runtime
- Runtime language switching (via QTranslator)
- Automatic plural handling
- Context-aware translations
- Fallback mechanism (requested ‚Üí system ‚Üí English)

**Qt i18n Advantages:**
- Integrated workflow (lupdate ‚Üí Linguist ‚Üí lrelease)
- Visual translation tool (Qt Linguist)
- Automatic string extraction (lupdate)
- Context preservation (class/function names)
- Plural forms support (English 2, Polish 3, Arabic 6)
- Gender support (via %1, %2 placeholders)
- Professional translator-friendly (.ts XML format)

---

## Architecture (Qt i18n)

### Core Components

#### 1. QTranslator System

Qt's QTranslator handles loading and applying translations:

```cpp
#include <QApplication>
#include <QTranslator>
#include <QLocale>

class Kalahari App : public QApplication {
public:
    KalahariApp(int &argc, char **argv) : QApplication(argc, argv) {
        loadTranslation("pl");  // Load Polish translation
    }

    void loadTranslation(const QString& locale) {
        // Remove old translator
        if (m_translator) {
            removeTranslator(m_translator);
            delete m_translator;
        }

        // Load new translator
        m_translator = new QTranslator(this);
        QString qmFile = QString("kalahari_%1.qm").arg(locale);

        if (m_translator->load(qmFile, ":/translations")) {
            installTranslator(m_translator);

            // Notify all widgets to retranslate
            emit languageChanged();
        }
    }

signals:
    void languageChanged();

private:
    QTranslator* m_translator = nullptr;
};
```

#### 2. Translatable Strings with tr()

Use `tr()` macro for all user-visible strings:

```cpp
#include <QString>

class MainWindow : public QMainWindow {
    Q_OBJECT

public:
    MainWindow() {
        // tr() macro marks strings for translation
        setWindowTitle(tr("Kalahari - Writer's IDE"));

        // Context preserved automatically (class name)
        m_fileMenu = menuBar()->addMenu(tr("&File"));
        m_newAction = m_fileMenu->addAction(tr("&New Project..."));

        // Comments for translators
        //: This is the main editor tab title
        m_editorTab->setTabText(0, tr("Editor"));

        // Placeholders for dynamic content
        //: %1 is the document title
        statusBar()->showMessage(tr("Opened: %1").arg(docTitle));
    }

protected:
    // Retranslate UI when language changes
    void changeEvent(QEvent* event) override {
        if (event->type() == QEvent::LanguageChange) {
            retranslateUi();
        }
        QMainWindow::changeEvent(event);
    }

private:
    void retranslateUi() {
        setWindowTitle(tr("Kalahari - Writer's IDE"));
        m_fileMenu->setTitle(tr("&File"));
        m_newAction->setText(tr("&New Project..."));
    }

    QMenu* m_fileMenu;
    QAction* m_newAction;
    QTabWidget* m_editorTab;
};
```

#### 3. Plural Forms

Qt handles plural forms automatically:

```cpp
// English: 1 file, 2 files
// Polish: 1 plik, 2 pliki, 5 plik√≥w
// Arabic: 1, 2, 3-10, 11+

int fileCount = 5;
QString message = tr("%n file(s) selected", "", fileCount);

// .ts file will have entries for each plural form:
// <numerusform>%n file selected</numerusform>        (English singular)
// <numerusform>%n files selected</numerusform>       (English plural)
// <numerusform>Wybrano %n plik</numerusform>         (Polish singular)
// <numerusform>Wybrano %n pliki</numerusform>        (Polish 2-4)
// <numerusform>Wybrano %n plik√≥w</numerusform>       (Polish 5+)
```

---

## Translation Workflow

### Phase 1: String Extraction (lupdate)

Extract translatable strings from source code:

```bash
# Update .ts files from C++ sources
lupdate src/*.cpp include/**/*.h -ts translations/kalahari_pl.ts
lupdate src/*.cpp include/**/*.h -ts translations/kalahari_de.ts

# With CMake:
cmake --build . --target lupdate
```

**What lupdate does:**
- Scans C++ files for tr() calls
- Extracts strings + context (class/function names)
- Updates .ts XML files
- Preserves existing translations
- Marks obsolete strings

### Phase 2: Translation (Qt Linguist)

Use **Qt Linguist** visual tool for translation:

```bash
# Open translation file
linguist translations/kalahari_pl.ts
```

**Qt Linguist Features:**
- Visual string browser with context
- Translation memory (reuse previous translations)
- Glossary support
- Validation (missing translations, placeholders)
- Fuzzy matching suggestions
- Source code preview

**Example .ts file structure:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE TS>
<TS version="2.1" language="pl_PL">
<context>
    <name>MainWindow</name>
    <message>
        <location filename="main_window.cpp" line="42"/>
        <source>&amp;File</source>
        <translation>&amp;Plik</translation>
    </message>
    <message>
        <location filename="main_window.cpp" line="43"/>
        <source>&amp;New Project...</source>
        <translation>&amp;Nowy projekt...</translation>
    </message>
    <message numerus="yes">
        <source>%n file(s) selected</source>
        <translation>
            <numerusform>Wybrano %n plik</numerusform>
            <numerusform>Wybrano %n pliki</numerusform>
            <numerusform>Wybrano %n plik√≥w</numerusform>
        </translation>
    </message>
</context>
</TS>
```

### Phase 3: Compilation (lrelease)

Compile .ts to binary .qm files:

```bash
# Compile .ts ‚Üí .qm
lrelease translations/kalahari_pl.ts -qm translations/kalahari_pl.qm

# With CMake:
cmake --build . --target lrelease
```

**What lrelease does:**
- Compiles .ts XML ‚Üí .qm binary
- Optimizes for fast runtime loading
- Includes only finished translations
- Warnings for incomplete translations

### Phase 4: Deployment

Embed .qm files in application:

```cmake
# CMakeLists.txt
qt6_add_translation(QM_FILES
    translations/kalahari_pl.ts
    translations/kalahari_de.ts
    translations/kalahari_fr.ts
)

qt6_add_resources(RESOURCES
    translations/translations.qrc
)

add_executable(kalahari ${SOURCES} ${QM_FILES} ${RESOURCES})
```

**translations.qrc:**
```xml
<!DOCTYPE RCC>
<RCC version="1.0">
<qresource prefix="/translations">
    <file>kalahari_pl.qm</file>
    <file>kalahari_de.qm</file>
    <file>kalahari_fr.qm</file>
</qresource>
</RCC>
```

---

## Language Selection UI

### Settings Dialog Integration

```cpp
class LanguageSettingsPanel : public QWidget {
public:
    LanguageSettingsPanel(QWidget* parent = nullptr) : QWidget(parent) {
        QVBoxLayout* layout = new QVBoxLayout(this);

        QGroupBox* langGroup = new QGroupBox(tr("Language"), this);
        QVBoxLayout* langLayout = new QVBoxLayout(langGroup);

        // Language combo box
        m_languageCombo = new QComboBox(langGroup);
        m_languageCombo->addItem(QIcon(":/flags/en.png"), "English", "en");
        m_languageCombo->addItem(QIcon(":/flags/pl.png"), "Polski", "pl");
        m_languageCombo->addItem(QIcon(":/flags/de.png"), "Deutsch", "de");
        m_languageCombo->addItem(QIcon(":/flags/fr.png"), "Fran√ßais", "fr");

        // Load current language from settings
        QSettings settings;
        QString currentLang = settings.value("language", "en").toString();
        int index = m_languageCombo->findData(currentLang);
        m_languageCombo->setCurrentIndex(index);

        connect(m_languageCombo, QOverload<int>::of(&QComboBox::currentIndexChanged),
                this, &LanguageSettingsPanel::onLanguageChanged);

        langLayout->addWidget(m_languageCombo);
        layout->addWidget(langGroup);
    }

private slots:
    void onLanguageChanged(int index) {
        QString locale = m_languageCombo->itemData(index).toString();

        // Save to settings
        QSettings settings;
        settings.setValue("language", locale);

        // Apply immediately
        qobject_cast<KalahariApp*>(qApp)->loadTranslation(locale);

        // Inform user
        QMessageBox::information(this, tr("Language Changed"),
            tr("Language has been changed. Some elements will update immediately, "
               "others will update when you reopen dialogs."));
    }

    QComboBox* m_languageCombo;
};
```

---

## Plugin Translations

Plugins can provide their own .qm files:

```cpp
// In plugin's onLoad()
void MyPlugin::onLoad() {
    // Load plugin-specific translations
    QTranslator* pluginTranslator = new QTranslator(this);
    QString pluginQm = QString("plugin_myplugin_%1.qm")
        .arg(QLocale::system().name());

    if (pluginTranslator->load(pluginQm, ":/plugin/translations")) {
        qApp->installTranslator(pluginTranslator);
    }
}
```

---

## Supported Languages

### MVP (Phase 1-2):
- üá¨üáß **English** (en) - Primary, 100%
- üáµüá± **Polish** (pl) - Secondary, 100%

### Phase 2+ (Community/Professional):
- üá©üá™ **German** (de)
- üá´üá∑ **French** (fr)
- üá™üá∏ **Spanish** (es)
- üáÆüáπ **Italian** (it)

### Plural Forms:
- **English/German/French/Spanish/Italian:** 2 forms (singular, plural)
- **Polish:** 3 forms (1, 2-4, 5+)
- **Russian/Czech:** 3 forms (different rules)
- **Arabic:** 6 forms (0, 1, 2, 3-10, 11-99, 100+)

---

## Best Practices

### 1. Always use tr()
```cpp
// ‚úÖ GOOD
label->setText(tr("Hello World"));
button->setText(tr("&Save"));

// ‚ùå BAD
label->setText("Hello World");  // Not translatable!
```

### 2. Provide context comments
```cpp
//: Appears in the main menu bar
m_fileMenu = menuBar()->addMenu(tr("&File"));

//: Status bar message when file is saved
//: %1 is the file path
statusBar()->showMessage(tr("Saved: %1").arg(path));
```

### 3. Use placeholders for dynamic content
```cpp
// ‚úÖ GOOD - translators can reorder placeholders
tr("User %1 has %2 messages").arg(userName).arg(count);

// ‚ùå BAD - English-specific word order
tr("User ") + userName + tr(" has ") + count + tr(" messages");
```

### 4. Handle plurals correctly
```cpp
// ‚úÖ GOOD
tr("%n file(s) found", "", fileCount);

// ‚ùå BAD - English-only
QString("%1 file%2 found").arg(fileCount).arg(fileCount == 1 ? "" : "s");
```

### 5. Keep strings short and simple
```cpp
// ‚úÖ GOOD
tr("Save changes?");
tr("Discard changes?");

// ‚ùå BAD - long, complex sentences hard to translate
tr("Do you want to save the changes you made to the document before closing it?");
```

---

## Testing

### Pseudo-Localization

Test UI layout with long strings:

```cpp
// Create pseudo-translation
QString pseudoTranslate(const QString& text) {
    // Add prefix/suffix, repeat vowels to simulate long German words
    return "[" + text.replace(QRegularExpression("[aeiou]"), "\\0\\0") + "]";
}
```

### Visual Verification

- ‚úÖ All text fits in widgets (no truncation)
- ‚úÖ Keyboard shortcuts work (& markers)
- ‚úÖ Dialogs resize correctly
- ‚úÖ Right-to-left languages (future: Arabic, Hebrew)

---

## Migration from wxWidgets

**Previous System (Archived):**
- wxWidgets wxLocale + GNU gettext
- .po (Portable Object) / .mo (Machine Object) format
- Macro: `_()`
- bwx_sdk::bwxInternat custom class

**New System (Qt):**
- Qt QTranslator + lupdate/linguist/lrelease
- .ts (Translation Source) / .qm (Qt Message) format
- Macro: `tr()`
- Standard Qt i18n workflow

**Migration Benefits:**
- Visual translation tool (Qt Linguist)
- Integrated CMake workflow
- Better plural handling
- Context preservation
- No custom wrapper class needed

**Reference:** Previous implementation available in wxwidgets-archive branch (commit e191390).

---

## Timeline

- **Phase 0 (Qt Foundation):** Basic English UI
- **Phase 1 (Core Editor):** English + Polish skeleton
- **Phase 2 (Plugin MVP):** Full English + Polish translations
- **Phase 3+ (Community):** German, French, Spanish, Italian

---

**Document Version:** 2.0 (Qt i18n)
**Last Update:** 2025-11-19
**Updated By:** Claude (Qt migration - complete rewrite)
