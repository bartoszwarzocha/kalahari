{
  "workflow": {
    "name": "kalahari-standard",
    "version": "1.0",

    "protocol": {
      "status_block_marker": "[WORKFLOW_STATUS]",
      "valid_statuses": ["READY", "BLOCKED", "FAILED", "DECISION_NEEDED"],

      "fallback_patterns": {
        "READY": "READY|DONE|COMPLETE|PASS|APPROVE|SUCCESS|CREATED|DEPLOYED",
        "BLOCKED": "BLOCKED|CHANGES|REJECT|NEED|REQUEST_CHANGES|ISSUES|MISSING",
        "FAILED": "FAIL|ERROR|ABORT|CRITICAL|CANNOT|FATAL"
      },
      "pattern_priority": ["FAILED", "BLOCKED", "READY"],
      "fallback_search_lines": 10,
      "on_unknown_status": "ask_user"
    },

    "limits": {
      "max_workflow_iterations": 20,
      "max_retries_per_rule": 3,
      "agent_timeout_seconds": 300
    },

    "prompt_injection": {
      "enabled": true,
      "template": "STATUS_PROTOCOL_V1"
    },

    "triggers": {
      "task-manager": [
        "session", "nowe zadanie", "new task", "kontynuuj task", "continue task",
        "wznów", "co dalej", "status taska", "zamknij task", "status",
        "gdzie jesteśmy", "task gotowy"
      ],
      "architect": [
        "zaprojektuj", "przeanalizuj", "jak to zrobić", "gdzie to dodać", "design"
      ],
      "code-writer": [
        "napisz", "utwórz klasę", "dodaj nową funkcję", "nowy plik", "create", "new class"
      ],
      "code-editor": [
        "zmień", "popraw", "napraw", "refaktoruj", "refaktoryzuj", "fix", "modify", "change", "refactor"
      ],
      "ui-designer": [
        "dialog", "panel", "toolbar", "UI", "widget", "layout", "window", "przygotuj", "GUI"
      ],
      "code-reviewer": [
        "review", "sprawdź kod", "przed commitem", "czy mogę commitować", "code review"
      ],
      "tester": [
        "testy", "przetestuj", "uruchom testy", "QA", "czy działa", "run tests"
      ],
      "devops": [
        "CI", "CD", "napraw CI", "pipeline", "GitHub Actions", "workflow failed",
        "build failed", "deploy"
      ]
    },

    "rules": [
      {
        "id": "session_restore",
        "description": "Auto-restore session on SessionStart hook - HIGHEST PRIORITY",
        "priority": 100,
        "trigger": {
          "type": "session_start",
          "requires_session_file": true
        },
        "action": {
          "agent": "task-manager",
          "mode": "session_restore",
          "prompt": "SESSION INSTRUCTION detected. Read .claude/session-state.json, display session status box, ask user to continue or start new task."
        }
      },

      {
        "id": "initial",
        "description": "Start workflow with task-manager",
        "trigger": { "type": "start" },
        "action": {
          "agent": "task-manager",
          "prompt_mode": "passthrough"
        }
      },

      {
        "id": "task_to_architect",
        "description": "After task created/continued, run architect",
        "trigger": {
          "agent": "task-manager",
          "status": "READY",
          "context_excludes": "DEPLOYED|closed|complete"
        },
        "action": {
          "agent": "architect",
          "prompt": "Analyze and design solution based on the OpenSpec. Context: {context}"
        }
      },

      {
        "id": "task_needs_edit",
        "description": "User wants to edit specification",
        "trigger": {
          "agent": "task-manager",
          "status": "DECISION_NEEDED",
          "context_contains": "edit|modify|add|change|update spec"
        },
        "action": {
          "agent": "task-manager",
          "prompt": "User wants to modify the specification. Ask what they want to change and update the OpenSpec files accordingly. Context: {context}"
        }
      },

      {
        "id": "architect_decision",
        "description": "After design, choose implementation approach",
        "trigger": {
          "agent": "architect",
          "status": "READY"
        },
        "action": {
          "type": "decision",
          "message": "Design complete. Choose implementation approach:",
          "options": [
            {"key": "1", "label": "New files (code-writer)", "agent": "code-writer"},
            {"key": "2", "label": "Modify existing (code-editor)", "agent": "code-editor"},
            {"key": "3", "label": "UI component (ui-designer)", "agent": "ui-designer"}
          ],
          "prompt_template": "Implement according to design. Context: {context}"
        }
      },

      {
        "id": "implementation_to_review",
        "description": "After implementation, run code review",
        "trigger": {
          "agent": ["code-writer", "code-editor", "ui-designer"],
          "status": "READY"
        },
        "action": {
          "agent": "code-reviewer",
          "prompt": "Review the implemented changes"
        }
      },

      {
        "id": "review_blocked_loop",
        "description": "Review found issues, fix them",
        "trigger": {
          "agent": "code-reviewer",
          "status": "BLOCKED"
        },
        "action": {
          "agent": "code-editor",
          "prompt": "Fix the issues found in review: {context}",
          "on_complete": "implementation_to_review"
        },
        "retry": {
          "max": 3,
          "on_exhausted": {
            "type": "ask_user",
            "message": "Review loop exceeded 3 attempts. Manual intervention needed."
          }
        }
      },

      {
        "id": "review_to_tests",
        "description": "After review approved, run tests",
        "trigger": {
          "agent": "code-reviewer",
          "status": "READY"
        },
        "action": {
          "agent": "tester",
          "prompt": "Run build and tests"
        }
      },

      {
        "id": "tests_blocked_loop",
        "description": "Tests failed, fix them",
        "trigger": {
          "agent": "tester",
          "status": "BLOCKED"
        },
        "action": {
          "agent": "code-editor",
          "prompt": "Fix failing tests: {context}",
          "on_complete": "review_to_tests"
        },
        "retry": {
          "max": 3,
          "on_exhausted": {
            "type": "ask_user",
            "message": "Test fix loop exceeded 3 attempts."
          }
        }
      },

      {
        "id": "tests_to_close",
        "description": "Tests passed, close task",
        "trigger": {
          "agent": "tester",
          "status": "READY"
        },
        "action": {
          "agent": "task-manager",
          "prompt": "Close the task - all checks passed"
        }
      },

      {
        "id": "workflow_complete",
        "description": "Task closed, workflow complete",
        "trigger": {
          "agent": "task-manager",
          "status": "READY",
          "context_contains": "DEPLOYED|closed|complete"
        },
        "action": {
          "type": "complete",
          "message": "Workflow completed successfully!"
        }
      }
    ]
  }
}
